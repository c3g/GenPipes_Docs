.. _docs_steps_illumina:
  
.. spelling::

      md

Step Details
-------------

Following are the various steps that are part of GenPipes Illumina Sequencing genomic analysis pipeline:

.. _Index:

**Index**

This step generates a file with all the indexes found in the index-reads of the run.
The input barcode file is a two columns tsv file. Each line has a barcode_sequence and the corresponding barcode_name. This file can be generated by a LIMS.

The output is a tsv file named RUNFOLDER_LANENUMBER.metrics that will be saved in the output directory. This file has four columns, the barcode/index sequence, the index name, the number of reads and the number of reads that have passed the filter.

.. _FASTQ Step:

**FASTQ Step**

This step launches FASTQ generation from Illumina raw data using BCL2FASTQ conversion software.
The index base mask is calculated according to the sample and run configuration; and also according the mask parameters received (first/last index bases). The Casava sample sheet is generated with this mask. The default number of mismatches allowed in the index sequence is 1 and can be overridden with an command line argument. No demultiplexing occurs when there is only one sample in the lane.

An optional notification command can be launched to notify the start of the fastq generation with the calculated mask.

.. _Align:

**Align**

In this step, reads are aligned from the fastq file, sort the resulting .bam and create an index of that .bam.  An basic alignment is performed on a sample when the SampleRef field of the Illumina sample sheet match one of the regexp in the configuration file and the corresponding genome (and indexes) are installed.  `STAR Software`_ is used as a splice-junctions aware aligner when the sample library_source is cDNA or contains RNA; otherwise BWA_mem is used to align the reads.

For details, refer to `STAR User Guide`_.

.. _Picard Mark Duplicates:

**Picard Mark Duplicates**

Runs Picard mark duplicates on the sorted BAM file.

.. _Metrics:

**Metrics**

This step runs a series of multiple metrics collection jobs and the output bam from mark duplicates.

* Picard CollectMultipleMetrics: A collection of picard metrics that runs at the same time to save on I/O.
  - CollectAlignmentSummaryMetrics,
  - CollectInsertSizeMetrics,
  - QualityScoreDistribution,
  - MeanQualityByCycle,
  - CollectBaseDistributionByCycle
* BVATools DepthOfCoverage: Using the specified BED Files in the sample sheet, calculate the coverage of each target region.
* Picard CalculateHsMetrics: Calculates a set of Hybrid Selection specific metrics from the BAM file. The bait and interval list is automatically created from the specified BED Files.

.. _BLAST Step:

**BLAST Step**

Runs BLAST on a subsample of the reads of each sample to find the 20 most frequent hits.  The runBlast.sh tool from MUGQIC Tools is used. The number of reads to subsample can be configured by sample or for the whole lane. The output will be in the Blast_sample folder, under the Unaligned folder.

.. _QC Graphs Step:

**QC Graphs Step**

Generate some QC Graphics and a summary XML file for each sample using `BVATools`_.

Files are created in a 'qc' subfolder of the fastq directory. Examples of output graphic:

* Per cycle qualities, sequence content and sequence length;
* Known sequences (adapters);
* Abundant Duplicates

.. _MD5 Step:

**MD5 Step**

Create md5 checksum files for the fastq, BAM and BAI using the system 'md5sum' utility.  One checksum file is created for each file.

.. _Copy Step:

**Copy Step**

Copy processed files to another place where they can be served or loaded into a LIMS.  The destination folder and the command used can be set in the configuration file.
An optional notification can be sent before the copy. The command used is in the configuration file. 

.. _End Copy Notification:

**End Copy Notification**

Send an optional notification to notify that the copy is finished.  The command used is in the configuration file. This step is skipped when no command is provided. 

.. The following html links are used in the text above

.. _STAR User Guide: https://github.com/alexdobin/STAR/blob/master/doc/STARmanual.pdf 

.. _STAR Software: https://github.com/alexdobin/STAR

.. _BVATools: https://bitbucket.org/mugqic/bvatools/
